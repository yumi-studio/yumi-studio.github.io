<div class="main-heart-app">
    <div class="container-fluid">
        <div class="opening">
            <h4>Tớ có cái này muốn cho cậu xem</h4>
            <h4>Cậu đồng ý nhé!</h4>
            <div class="opening-selection">
                <button id="accept-btn">"Tớ đồng ý"</button>
            </div>
        </div>
        <div class="heart-wrapper">
            <div class="heart-front heart-front-beat">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 4.419c-2.826-5.695-11.999-4.064-11.999 3.27 0 7.27 9.903 10.938 11.999 15.311 2.096-4.373 12-8.041 12-15.311 0-7.327-9.17-8.972-12-3.27z"/>
                </svg>
            </div>
            <div class="heart-front heart-front-outline">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M17.516 3c2.382 0 4.487 1.564 4.487 4.712 0 4.963-6.528 8.297-10.003 11.935-3.475-3.638-10.002-6.971-10.002-11.934 0-3.055 2.008-4.713 4.487-4.713 3.18 0 4.846 3.644 5.515 5.312.667-1.666 2.333-5.312 5.516-5.312zm0-2c-2.174 0-4.346 1.062-5.516 3.419-1.17-2.357-3.342-3.419-5.515-3.419-3.403 0-6.484 2.39-6.484 6.689 0 7.27 9.903 10.938 11.999 15.311 2.096-4.373 12-8.041 12-15.311 0-4.586-3.414-6.689-6.484-6.689z"/>
                </svg>
            </div>
            <div class="heart-front heart-front-outline-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M17.516 3c2.382 0 4.487 1.564 4.487 4.712 0 4.963-6.528 8.297-10.003 11.935-3.475-3.638-10.002-6.971-10.002-11.934 0-3.055 2.008-4.713 4.487-4.713 3.18 0 4.846 3.644 5.515 5.312.667-1.666 2.333-5.312 5.516-5.312zm0-2c-2.174 0-4.346 1.062-5.516 3.419-1.17-2.357-3.342-3.419-5.515-3.419-3.403 0-6.484 2.39-6.484 6.689 0 7.27 9.903 10.938 11.999 15.311 2.096-4.373 12-8.041 12-15.311 0-4.586-3.414-6.689-6.484-6.689z"/>
                </svg>
            </div>
            <div class="heart-mask">
                <div class="heart-particles">
  
                </div>
            </div>
        </div>
        <div class="dashboard">
            <div class="heart-options">
  
            </div>
            <div style="display: none">
                <label for="heart-count">No. Heart</label><input id="heart-count" name="heart-count" type="text"
                                                                 disabled>
            </div>
        </div>
    </div>
  </div>
  <style>
  body {
    --heart-size: 15px;
    --heart-front-rotate: 0deg;
    --heart-front-size: 0px;
    --base-color: #ff2ec8;
    --heart-clip-path: 'none';
    margin: 0;
    padding: 0;
    background: black;
  }
  
  .hidden {
    display: none !important;
  }
  
  [purpose='page-wrap'] {
    padding: 0;
  }
  
  .container-fluid {
    padding: 0;
  }
  
  .navbar {
    display: none !important;
  }
  
  .heart-wrapper {
    height: 100vh;
    width: 100%;
    position: relative;
    overflow: hidden;
    opacity: 0;
    transition: ease 3s;
  }
  
  .heart-wrapper.active {
    opacity: 1;
  }
  
  .heart-front {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: var(--heart-front-size);
    height: auto;
    z-index: 6;
    filter: drop-shadow(0px 0px 30px var(--base-color));
    animation: heart-front-beat .3s ease-in-out infinite alternate;
    transform-origin: center;
    cursor: pointer;
  }
  
  .heart-front svg {
    width: 100%;
    height: 100%;
  }
  
  .heart-front-outline {
    width: var(--heart-front-size);
    transform-origin: center;
    animation: heart-outline-fade ease-out 0.6s infinite forwards;
    opacity: 0.5;
    transform: translate(-50%, -50%) scale(1);
    fill: var(--base-color);
    z-index: 5;
  }
  
  @keyframes heart-outline-fade {
    to {
      opacity: 0;
      transform: translate(-50%, -50%) scale(1.6);
    }
  }
  
  .heart-front-outline-2 {
    width: var(--heart-front-size);
    transform-origin: center;
    animation: heart-outline-fade-2 ease-out 0.6s infinite forwards;
    opacity: 0.5;
    transform: translate(-50%, -50%) scale(1);
    fill: var(--base-color);
    z-index: 4;
  }
  
  @keyframes heart-outline-fade-2 {
    to {
      opacity: 0;
      transform: translate(-50%, -50%) scale(1.8);
    }
  }
  
  .heart-mask {
    background: black;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: var(--heart-front-size);
    height: auto;
    filter: drop-shadow(0px 0px 30px var(--base-color));
    /*animation: heart-front-beat .3s ease-in-out infinite alternate;*/
    transform-origin: center;
    z-index: 1;
    clip-path: var(--heart-clip-path);
  }
  
  .heart-particles {
    width: 1px;
    height: 1px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(calc((var(--heart-size) / -2)), calc(var(--heart-size) / -2));
    fill: var(--base-color);
    z-index: 1;
    /*animation: heart-particles-beat .3s infinite alternate;*/
    transform-origin: center;
  }
  
  @keyframes heart-front-beat {
    to {
      transform: translate(-50%, -50%) rotate(0) scale(1.4);
    }
  }
  
  @keyframes heart-particles-beat {
    to {
      transform: translate(calc((var(--heart-size) / -2)), calc(var(--heart-size) / -2)) scale(1.2);
    }
  }
  
  .small-heart {
    --offset: 0;
    --angle: 0;
    --rotate: 0;
    --duration: 0;
    --scale: 1;
    width: var(--heart-size);
    height: var(--heart-size);
    position: absolute;
    top: 50%;
    left: 50%;
    animation-name: heart-fade;
    animation-duration: var(--duration);
    animation-fill-mode: forwards;
    animation-timing-function: ease;
    transform-origin: center;
  
    opacity: 1;
    transform: rotate(var(--angle)) translate(0, 0) scale(var(--scale)) rotate(0);
  
  }
  
  .small-heart svg {
    width: 100%;
    height: 100%;
  }
  
  @keyframes heart-fade {
    to {
      opacity: 0;
      transform: rotate(var(--angle)) translate(0, var(--offset)) scale(var(--scale)) rotate(var(--rotate));
    }
  }
  
  .heart-bg {
    width: 0;
    height: 0;
    border-radius: 50%;
    background-color: transparent;
    box-shadow: 0 0 60px 30px #fff,
    0 0 480px 50px deeppink;
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
  }
  
  .dashboard {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translate(-50%, 100%);
    transition: ease 0.25s;
    padding: 15px;
    z-index: 999;
  }
  
  .dashboard.active {
    transform: translate(-50%, 0);
  }
  
  .dashboard input {
    width: 50px;
    margin-left: 15px;
  }
  
  .heart-options {
    display: inline-flex;
  }
  
  .heart-option {
    display: flex;
    padding: 5px 10px;
    fill: white;
    width: auto;
    height: auto;
  }
  
  .heart-option svg {
    height: 40px;
    width: auto;
  }
  
  .heart-option.active {
    fill: var(--base-color);
  }
  
  .opening {
    --font-size: 24px;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 999;
    padding: 15px;
    color: white;
    text-align: center;
    width: 100%;
    transition: ease 1s;
  }
  
  .opening.close {
    top: 0;
    transform: translate(-50%, -100%);
    opacity: 0;
  }
  
  .opening h4 {
    font-size: var(--font-size);
    width: 100%;
  }
  
  .opening #accept-btn {
    font-size: var(--font-size);
    border-radius: 1000px;
    padding: 0 50px;
    margin-top: 15px;
  }
  
  @media screen and (min-width: 480px) {
    .opening {
      --font-size: 24px;
    }
  }
  
  @media screen and (min-width: 480px) {
    .opening {
      --font-size: 36px;
    }
  }
  </style>
  <script type="text/javascript">
  const HeartApp = {
    hearts: new Map(),
    heartTpl: [
      `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 4.419c-2.826-5.695-11.999-4.064-11.999 3.27 0 7.27 9.903 10.938 11.999 15.311 2.096-4.373 12-8.041 12-15.311 0-7.327-9.17-8.972-12-3.27z"/></svg>`,
      `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17.516 3c2.382 0 4.487 1.564 4.487 4.712 0 4.963-6.528 8.297-10.003 11.935-3.475-3.638-10.002-6.971-10.002-11.934 0-3.055 2.008-4.713 4.487-4.713 3.18 0 4.846 3.644 5.515 5.312.667-1.666 2.333-5.312 5.516-5.312zm0-2c-2.174 0-4.346 1.062-5.516 3.419-1.17-2.357-3.342-3.419-5.515-3.419-3.403 0-6.484 2.39-6.484 6.689 0 7.27 9.903 10.938 11.999 15.311 2.096-4.373 12-8.041 12-15.311 0-4.586-3.414-6.689-6.484-6.689z"/></svg>`,
      `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17.867 3.493l4.133 3.444v5.127l-10 8.333-10-8.334v-5.126l4.133-3.444 5.867 3.911 5.867-3.911zm.133-2.493l-6 4-6-4-6 5v7l12 10 12-10v-7l-6-5z"/></svg>`,
      `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M24 10h-10v-10h-4v10h-10v4h10v10h4v-10h10z"/></svg>`,
      `<svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m11.322 2.923c.126-.259.39-.423.678-.423.289 0 .552.164.678.423.974 1.998 2.65 5.44 2.65 5.44s3.811.524 6.022.829c.403.055.65.396.65.747 0 .19-.072.383-.231.536-1.61 1.538-4.382 4.191-4.382 4.191s.677 3.767 1.069 5.952c.083.462-.275.882-.742.882-.122 0-.244-.029-.355-.089-1.968-1.048-5.359-2.851-5.359-2.851s-3.391 1.803-5.359 2.851c-.111.06-.234.089-.356.089-.465 0-.825-.421-.741-.882.393-2.185 1.07-5.952 1.07-5.952s-2.773-2.653-4.382-4.191c-.16-.153-.232-.346-.232-.535 0-.352.249-.694.651-.748 2.211-.305 6.021-.829 6.021-.829s1.677-3.442 2.65-5.44zm.678 2.033-2.361 4.792-5.246.719 3.848 3.643-.948 5.255 4.707-2.505 4.707 2.505-.951-5.236 3.851-3.662-5.314-.756z" fill-rule="nonzero"/></svg>`,
      `<svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m11.262 2.306c.196-.196.461-.306.738-.306s.542.11.738.306c1.917 1.917 7.039 7.039 8.956 8.956.196.196.306.461.306.738s-.11.542-.306.738c-1.917 1.917-7.039 7.039-8.956 8.956-.196.196-.461.306-.738.306s-.542-.11-.738-.306c-1.917-1.917-7.039-7.039-8.956-8.956-.196-.196-.306-.461-.306-.738s.11-.542.306-.738c1.917-1.917 7.039-7.039 8.956-8.956zm-7.573 9.694 8.311 8.311 8.311-8.311-8.311-8.311z" fill-rule="nonzero"/></svg>`,
    ],
    allowHeartList: [],
    isAcceptClick: false,
    musicUrl: '/sounds/anh-the-day-remix.mp3',
    frontHeartVectorMatrix: [
      '12 4.419000148773193',
      '11.627447128295898 3.764559745788574',
      '11.180187225341797 3.1587765216827393',
      '10.661539077758789 2.612910032272339',
      '10.078060150146484 2.136990547180176',
      '9.438959121704102 1.7388633489608765',
      '8.755045890808105 1.423829436302185',
      '8.037717819213867 1.1947768926620483',
      '7.2982048988342285 1.0527219772338867',
      '6.547182559967041 0.997471034526825',
      '5.794744491577148 1.0281789302825928',
      '5.050587177276611 1.1436786651611328',
      '4.324286460876465 1.3426412343978882',
      '3.6255478858947754 1.6234296560287476',
      '2.96435809135437 1.9838128089904785',
      '2.350904941558838 2.420501708984375',
      '1.7952238321304321 2.92864990234375',
      '1.306488037109375 3.501464366912842',
      '0.8921157717704773 4.130187034606934',
      '0.5569502115249634 4.804505825042725',
      '0.30274146795272827 5.51336145401001',
      '0.12817934155464172 6.2459635734558105',
      '0.0294918492436409 6.9926347732543945',
      '0.0012051640078425407 7.745319843292236',
      '0.04241282865405083 8.497371673583984',
      '0.1558096706867218 9.241961479187012',
      '0.3397267460823059 9.972349166870117',
      '0.5898013114929199 10.682840347290039',
      '0.8997108936309814 11.36938762664795',
      '1.2621047496795654 12.02978801727295',
      '1.6694694757461548 12.663480758666992',
      '2.11472225189209 13.271188735961914',
      '2.591491460800171 13.854534149169922',
      '3.094257354736328 14.415656089782715',
      '3.6183197498321533 14.956962585449219',
      '4.159604549407959 15.481064796447754',
      '4.714685916900635 15.990543365478516',
      '5.280572414398193 16.48801040649414',
      '5.854594707489014 16.9760684967041',
      '6.434314250946045 17.457353591918945',
      '7.0173258781433105 17.934648513793945',
      '7.601271152496338 18.410804748535156',
      '8.183687210083008 18.888830184936523',
      '8.761627197265625 19.372243881225586',
      '9.331611633300781 19.86500358581543',
      '9.889195442199707 20.37172508239746',
      '10.428339958190918 20.897993087768555',
      '10.940386772155762 21.450597763061523',
      '11.412507057189941 22.037534713745117',
      '11.825124740600586 22.667482376098633',
      '12.17582893371582 22.665828704833984',
      '12.588635444641113 22.035999298095703',
      '13.060894012451172 21.449174880981445',
      '13.573044776916504 20.89667510986328',
      '14.112245559692383 20.3704776763916',
      '14.66988754272461 19.863811492919922',
      '15.239912986755371 19.371103286743164',
      '15.817891120910645 18.887723922729492',
      '16.400327682495117 18.40973472595215',
      '16.98429298400879 17.933605194091797',
      '17.567323684692383 17.456327438354492',
      '18.147048950195312 16.97504997253418',
      '18.72108268737793 16.487009048461914',
      '19.286970138549805 15.98954963684082',
      '19.842052459716797 15.480067253112793',
      '20.383333206176758 14.955958366394043',
      '20.90736198425293 14.414619445800781',
      '21.41013526916504 13.853506088256836',
      '21.88688087463379 13.270145416259766',
      '22.33209991455078 12.662410736083984',
      '22.73942756652832 12.028688430786133',
      '23.101762771606445 11.368263244628906',
      '23.411605834960938 10.681680679321289',
      '23.661598205566406 9.971158981323242',
      '23.845415115356445 9.24074935913086',
      '23.95869255065918 8.496143341064453',
      '23.999786376953125 7.744091510772705',
      '23.971345901489258 6.991413116455078',
      '23.872406005859375 6.244777679443359',
      '23.697534561157227 5.512255668640137',
      '23.442996978759766 4.803523540496826',
      '23.107498168945312 4.12937068939209',
      '22.692874908447266 3.5008161067962646',
      '22.20395278930664 2.928161144256592',
      '21.648176193237305 2.420114040374756',
      '21.034713745117188 1.9834439754486084',
      '20.3735408782959 1.6230202913284302',
      '19.67485237121582 1.3421080112457275',
      '18.948583602905273 1.1430151462554932',
      '18.204458236694336 1.0273576974868774',
      '17.4520320892334 0.9965127110481262',
      '16.701005935668945 1.0517064332962036',
      '15.961504936218262 1.19377863407135',
      '15.244206428527832 1.4229216575622559',
      '14.56037712097168 1.738146185874939',
      '13.921417236328125 2.1364810466766357',
      '13.338125228881836 2.6126341819763184',
      '12.819656372070312 3.158667802810669',
      '12.372542381286621 3.7645530700683594',
      '12 4.419000148773193',
    ],
    spawnRate: 200,
    spawnCounter: 0,
    basicSize: 0,
    heartLifetime: {
      min: 4,
      max: 10
    },
    init: function () {
      const self = this;
      const screenW = window.innerWidth;
      const screenH = window.innerHeight;
      self.basicSize = screenW > screenH ? screenH : screenW;
      const heartFrontSize = Math.floor(self.basicSize * 0.3333333);
      const heartFront = document.querySelector('.heart-front');
      const heartFrontOutline = document.querySelector('.heart-front-outline');
      const heartFrontOutline2 = document.querySelector('.heart-front-outline-2');
      const dashboard = document.querySelector('.dashboard');
      const body = document.querySelector('body');
      body.style.setProperty('--heart-size', (self.basicSize / 40) + 'px');
      body.style.setProperty('--heart-front-size', heartFrontSize + 'px');
  
      let audio = new Audio(self.musicUrl);
      let isAudioPlay = false;
      audio.oncanplaythrough = function () {
        self.isAudioPlay = true;
        audio.play();
      };
      heartFront.addEventListener('click', function (e) {
        // if (isAudioPlay) {
        //   audio.pause();
        //   isAudioPlay = false;
        // } else {
        //   audio.play();
        //   isAudioPlay = true;
        // }
        dashboard.classList.toggle('active');
      });
  
      /* Start convert heart mask matrix */
      let minX = 100;
      let maxX = 0;
      let minY = 100;
      let maxY = 0;
      for (let i = 0; i < self.frontHeartVectorMatrix.length; i++) {
        let vector = self.frontHeartVectorMatrix[i].split(' ');
        if (vector[0] < minX) {
          minX = vector[0] * 1;
        }
        if (vector[0] > maxX) {
          maxX = vector[0] * 1;
        }
        if (vector[1] < minY) {
          minY = vector[1] * 1;
        }
        if (vector[1] > maxY) {
          maxY = vector[1] * 1;
        }
      }
      let deltaX = 50 - (maxX / 2);
      let deltaY = 50 - (maxY / 2);
      let lastX = 0;
      let lastY = 0;
      for (let i = 0; i < self.frontHeartVectorMatrix.length; i++) {
        let vector = self.frontHeartVectorMatrix[i].split(' ');
        let x = (vector[0] * 1 + deltaX);
        let y = (vector[1] * 1 + deltaY);
        self.frontHeartVectorMatrix[i] = ` ${x}% ${y}%`;
        lastX = x;
        lastY = y;
      }
      // document.querySelector('.heart-mask').style.width = '100%';
      // document.querySelector('.heart-mask').style.height = '100%';
      // document.querySelector('body').style.setProperty('--heart-clip-path', `polygon(evenodd,${self.frontHeartVectorMatrix.join(',')},${lastX}% 100%, 100% 100%, 100% 0%, 0% 0%, 0% 100%, ${lastX}% 100%)`);
  
      self.live();
      self.initDashboard();
      self.refreshDashboard();
    },
    initDashboard: function () {
      const self = this;
      self.heartTpl.forEach(function (value, index) {
        let ele = document.createElement('div');
        ele.classList.add('heart-option');
        ele.innerHTML = value;
        self.allowHeartList.push(index);
        ele.classList.add('active');
        // ele.addEventListener('click', function (e) {
        //   let found = self.allowHeartList.indexOf(index);
        //   if (found > -1) {
        //     self.allowHeartList.splice(found, 1);
        //     ele.classList.remove('active');
        //   } else {
        //     self.allowHeartList.push(index);
        //     ele.classList.add('active');
        //   }
        // });
        document.querySelector('.heart-options').append(ele);
      });
  
    },
    live: function () {
      const self = this;
      setTimeout(function () {
        if (self.spawnCounter > Math.floor(1000 / self.spawnRate)) {
          if (self.allowHeartList.length > 0) {
            self.spawnHeart();
          }
          self.spawnCounter = 0;
        } else {
          self.spawnCounter += 10;
        }
        self.live();
      }, 10);
    },
    refreshDashboard: function () {
      const self = this;
      setTimeout(function () {
        document.querySelector('#heart-count').value = self.hearts.size;
        self.refreshDashboard();
      }, 100);
    },
    spawnHeart: function () {
      const self = this;
      const keyHeart = 'h' + new Date().getTime();
      let rotation = Math.floor(Math.random() * 360);
      let duration = Math.floor(Math.random() * (this.heartLifetime.max - this.heartLifetime.min + 1)) + this.heartLifetime.min;
      let heartObj = {
        id: keyHeart,
        html: null,
        angle: rotation,
        rotation: rotation,
        scale: 1 + Math.random(),
        offset: (Math.floor(Math.random() * (self.basicSize * 0.75) - Math.floor(self.basicSize * 0.25)) + Math.floor(self.basicSize * 0.25)),
        duration: duration,
        durationLeft: duration,
        generate: function () {
          let ele = document.createElement('div');
          let randomTpl = Math.floor(Math.random() * self.allowHeartList.length);
          ele.innerHTML = `<div class="small-heart">${self.heartTpl[self.allowHeartList[randomTpl]]}</div>`;
          ele.firstChild.style.setProperty('--duration', `${this.duration}s`);
          ele.firstChild.style.setProperty('--offset', `${this.offset}px`);
          ele.firstChild.style.setProperty('--angle', `${this.angle}deg`);
          ele.firstChild.style.setProperty('--rotate', `${this.rotation}deg`);
          ele.firstChild.style.setProperty('--scale', `${this.scale}`);
          this.html = ele.firstChild;
          document.querySelector('.heart-particles').append(this.html);
          return this;
        },
        destroy: function () {
          this.html.remove();
          self.hearts.delete(this.id);
        },
        live: function () {
          const heartSelf = this;
          setTimeout(function () {
            heartSelf.durationLeft -= (100 / 1000);
            if (heartSelf.durationLeft < 0) {
              heartSelf.destroy();
            } else {
              heartSelf.live();
            }
          }, 100);
          return this;
        }
      };
      self.hearts.set(keyHeart, heartObj);
      heartObj.generate().live();
    },
    opening: function () {
      const self = this;
      return new Promise(function (resolve) {
        self.showOpening();
        document.querySelector('#accept-btn').addEventListener('click', function (ev) {
          document.querySelector('.opening').classList.add('close');
          document.querySelector('.heart-wrapper').classList.add('active');
          resolve(true);
        });
      });
    },
    showOpening: function () {
  
    },
  };
  HeartApp.opening().then(function () {
    HeartApp.init();
  });
  </script>
  